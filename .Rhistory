g_piramide_interativo <- ggplotly(g_piramide)
htmlwidgets::saveWidget(
g_piramide_interativo,
"Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE,
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes",
width = 1200,   # üëà define largura (em pixels)
height = 2000   # üëà define altura vertical maior
)
# converte para interativo e define tamanho do widget
g_piramide_interativo <- plotly::ggplotly(g_piramide, width = 1200, height = 2000)
# salva o HTML interativo
htmlwidgets::saveWidget(
widget = g_piramide_interativo,
file = "Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE,
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes"
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
# converte para interativo e define tamanho do widget
g_piramide_interativo <- plotly::ggplotly(g_piramide, width = 500, height = 3000)
# salva o HTML interativo
htmlwidgets::saveWidget(
widget = g_piramide_interativo,
file = "Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE,
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes"
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
# converte para interativo e define tamanho do widget
g_piramide_interativo <- plotly::ggplotly(g_piramide, width = 1000, height = 3000)
# salva o HTML interativo
htmlwidgets::saveWidget(
widget = g_piramide_interativo,
file = "Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE,
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes"
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
df <- full_join(epi_spp_count, base_spp_count, by = "Species") %>%
mutate(across(c(n_epi, n_base), ~replace_na(.x, 0)))
View(df)
# (opcional) ordenar por total absoluto
df <- df %>%
mutate(total = n_epi + n_base,
Species = fct_reorder(Species, total, .desc = TRUE))
View(df)
# (opcional) ordenar por total absoluto
df <- df %>%
mutate(total = n_epi + n_base,
Species = fct_reorder(Species, total, .desc = TRUE))
# --- 2) Long + sinal negativo para basebiontes ---
df_long <- df %>%
pivot_longer(c(n_epi, n_base), names_to = "grupo", values_to = "n") %>%
mutate(
grupo = recode(grupo, n_epi = "Epibiontes", n_base = "Basebiontes"),
n = if_else(grupo == "Basebiontes", -n, n)
)
View(df_long)
# fazemos a porcentagem%
df_long <- df_long %>%
group_by(grupo) %>%
mutate(
total_abs = sum(abs(n), na.rm = TRUE),
percentual = 100 * n / total_abs
) %>%
ungroup()
df_long
View(df_long)
# cria uma c√≥pia com percentual absoluto
df_long_excel <- df_long %>%
mutate(percentual = abs(percentual))  # deixa todos os percentuais positivos
writexl::write_xlsx(df_long_excel, "especies_contagem.xlsx")
# Gera o gr√°fico tipo "pir√¢mide"
# gr√°fico base com aes(text = ...) incluindo o percentual
g_piramide <- ggplot(df_long, aes(
x = n,
y = Species,
fill = grupo,
text = paste0(
"<b>Esp√©cie:</b> <i>", Species, "</i><br>",
"<b>Grupo:</b> ", grupo, "<br>",
"<b>Registros:</b> ", abs(n), "<br>",
"<b>Percentual:</b> ", round(abs(percentual), 2), "%"
)
)) +
geom_col(width = 0.8, color = "white") +
scale_fill_manual(
values = c("Epibiontes" = "#2E8B57", "Basebiontes" = "#E74C3C"),
name = "Grupo"
) +
scale_x_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
labs(
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes",
x = "N√∫mero de registros (esp√©cimes)",
y = "Esp√©cies"
) +
theme_minimal(base_size = 14) +
theme(
panel.grid.major.y = element_blank(),
panel.grid.minor = element_blank(),
axis.text.y = element_text(face = "italic"),
legend.position = "bottom",
plot.title = element_text(face = "bold", hjust = 0.5)
)
# converte para gr√°fico interativo (usa a est√©tica text como tooltip)
g_piramide_interativo <- ggplotly(
g_piramide,
tooltip = "text"  # üëà mostra exatamente o que definimos em text
)
# Mostra o gr√°fico
g_piramide
# converte para interativo e define tamanho do widget
g_piramide_interativo <- plotly::ggplotly(g_piramide, width = 1000, height = 3000)
# salva o HTML interativo
htmlwidgets::saveWidget(
widget = g_piramide_interativo,
file = "Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE,
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes"
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
# Gera o gr√°fico tipo "pir√¢mide"
# gr√°fico base com apenas o texto customizado
g_piramide <- ggplot(df_long, aes(
x = n,
y = Species,
fill = grupo,
text = paste0(
"<b>Esp√©cie:</b> <i>", Species, "</i><br>",
"<b>Grupo:</b> ", grupo, "<br>",
"<b>Registros:</b> ", abs(n), "<br>",
"<b>Percentual:</b> ", round(abs(percentual), 2), "%"
)
)) +
geom_col(width = 0.8, color = "white") +
scale_fill_manual(
values = c("Epibiontes" = "#2E8B57", "Basebiontes" = "#E74C3C"),
name = "Grupo"
) +
scale_x_continuous(
labels = abs,
expand = expansion(mult = c(0.05, 0.05))
) +
labs(
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes",
x = "N√∫mero de registros (esp√©cimes)",
y = "Esp√©cies"
) +
theme_minimal(base_size = 14) +
theme(
panel.grid.major.y = element_blank(),
panel.grid.minor = element_blank(),
axis.text.y = element_text(face = "italic"),
legend.position = "bottom",
plot.title = element_text(face = "bold", hjust = 0.5)
)
# converte para plotly, usando APENAS o texto customizado
g_piramide_interativo <- ggplotly(
g_piramide,
tooltip = "text"   # üëà mostra s√≥ o conte√∫do de 'text'
)
# converte para interativo e define tamanho do widget
g_piramide_interativo <- plotly::ggplotly(g_piramide, width = 1000, height = 3000)
# salva o HTML interativo
htmlwidgets::saveWidget(
widget = g_piramide_interativo,
file = "Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE,
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes"
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
# Gera o gr√°fico tipo "pir√¢mide"
# gr√°fico base com apenas o texto customizado
g_piramide <- ggplot(df_long, aes(
x = n,
y = Species,
fill = grupo,
text = paste0(
"<b>Esp√©cie:</b> <i>", Species, "</i><br>",
"<b>Grupo:</b> ", grupo, "<br>",
"<b>Registros:</b> ", abs(n), "<br>",
"<b>Percentual:</b> ", round(abs(percentual), 2), "%"
)
)) +
geom_col(width = 0.8, color = "white") +
scale_fill_manual(
values = c("Epibiontes" = "#2E8B57", "Basebiontes" = "#E74C3C"),
name = "Grupo"
) +
scale_x_continuous(
labels = abs,
expand = expansion(mult = c(0.05, 0.05))
) +
labs(
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes",
x = "N√∫mero de registros (esp√©cimes)",
y = "Esp√©cies"
) +
theme_minimal(base_size = 14) +
theme(
panel.grid.major.y = element_blank(),
panel.grid.minor = element_blank(),
axis.text.y = element_text(face = "italic"),
legend.position = "bottom",
plot.title = element_text(face = "bold", hjust = 0.5)
)
# converte para plotly, usando APENAS o texto customizado
g_piramide_interativo <- ggplotly(
g_piramide,
tooltip = "text"   # üëà mostra s√≥ o conte√∫do de 'text'
)
# Mostra o gr√°fico
g_piramide
# ‚úîÔ∏èSALVANDO‚úîÔ∏è
ggsave("Plots/espelhado_spp-contagem.png",
plot = g_piramide, width = 10, height = 40, dpi = 600, units = "in",
bg = "white" )  # üëà fundo branco garantido)
# converte para interativo e define tamanho do widget
g_piramide_interativo <- plotly::ggplotly(g_piramide, width = 1000, height = 3000)
# salva o HTML interativo
htmlwidgets::saveWidget(
widget = g_piramide_interativo,
file = "Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE,
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes"
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
# gr√°fico base com texto customizado
g_piramide <- ggplot(df_long, aes(
x = n,
y = Species,
fill = grupo,
text = paste0(
"<b>Esp√©cie:</b> <i>", Species, "</i><br>",
"<b>Grupo:</b> ", grupo, "<br>",
"<b>Registros:</b> ", abs(n), "<br>",
"<b>Percentual:</b> ", round(abs(percentual), 2), "%"
)
)) +
geom_col(width = 0.8, color = "white") +
scale_fill_manual(
values = c("Epibiontes" = "#2E8B57", "Basebiontes" = "#E74C3C"),
name = "Grupo"
) +
scale_x_continuous(labels = abs, expand = expansion(mult = c(0.05, 0.05))) +
labs(
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes",
x = "N√∫mero de registros (esp√©cimes)",
y = "Esp√©cies"
) +
theme_minimal(base_size = 14) +
theme(
panel.grid.major.y = element_blank(),
panel.grid.minor = element_blank(),
axis.text.y = element_text(face = "italic"),
legend.position = "bottom",
plot.title = element_text(face = "bold", hjust = 0.5)
)
# converte pra plotly
g_piramide_interativo <- ggplotly(g_piramide)
# remove tooltips padr√µes e mant√©m s√≥ o nosso texto
g_piramide_interativo <- plotly::style(
g_piramide_interativo,
hoverinfo = "text",          # s√≥ o conte√∫do de 'text'
text = g_piramide$data$text  # usa o nosso texto formatado
)
# Mostra o gr√°fico
g_piramide
# converte para interativo e define tamanho do widget
g_piramide_interativo <- plotly::ggplotly(g_piramide, width = 1000, height = 3000)
# salva o HTML interativo
htmlwidgets::saveWidget(
widget = g_piramide_interativo,
file = "Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE,
title = "Distribui√ß√£o de Esp√©cies entre Epibiontes e Basebiontes"
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
g_piramide <- ggplot(df_long, aes(
x = n, y = Species, fill = grupo,
text = paste0(
"<b>Esp√©cie:</b> <i>", Species, "</i><br>",
"<b>Grupo:</b> ", grupo, "<br>",
"<b>Registros:</b> ", abs(n), "<br>",
"<b>Percentual:</b> ", round(abs(percentual), 2), "%"
)
)) +
geom_col(width = 0.8, color = "white") +
scale_fill_manual(values = c("Epibiontes"="#2E8B57","Basebiontes"="#E74C3C")) +
scale_x_continuous(labels = abs) +
theme_minimal(base_size = 14) +
theme(
axis.text.y = element_text(face = "italic"),
legend.position = "bottom"
)
# converte e limpa tooltips autom√°ticos
g_piramide_interativo <- ggplotly(g_piramide, tooltip = "text")
for(i in seq_along(g_piramide_interativo$x$data)){
g_piramide_interativo$x$data[[i]]$hoverinfo <- "text"
g_piramide_interativo$x$data[[i]]$text <- g_piramide_interativo$x$data[[i]]$text
}
htmlwidgets::saveWidget(
g_piramide_interativo,
"Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
# gr√°fico base com texto customizado
g_piramide <- ggplot(df_long, aes(
x = n, y = Species, fill = grupo,
text = paste0(
"<b>Esp√©cie:</b> <i>", Species, "</i><br>",
"<b>Grupo:</b> ", grupo, "<br>",
"<b>Registros:</b> ", abs(n), "<br>",
"<b>Percentual:</b> ", round(abs(percentual), 2), "%"
)
)) +
geom_col(width = 0.8, color = "white") +
scale_fill_manual(values = c("Epibiontes"="#2E8B57","Basebiontes"="#E74C3C")) +
scale_x_continuous(labels = abs) +
theme_minimal(base_size = 14) +
theme(
axis.text.y = element_text(face = "italic"),
legend.position = "bottom"
)
# converte e limpa tooltips autom√°ticos
g_piramide_interativo <- ggplotly(g_piramide, tooltip = "text",
width = 1000, height = 3000)
for(i in seq_along(g_piramide_interativo$x$data)){
g_piramide_interativo$x$data[[i]]$hoverinfo <- "text"
g_piramide_interativo$x$data[[i]]$text <- g_piramide_interativo$x$data[[i]]$text
}
htmlwidgets::saveWidget(
g_piramide_interativo,
"Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
# gr√°fico base com texto customizado
g_piramide <- ggplot(df_long, aes(
x = n, y = Species, fill = grupo,
text = paste0(
"<b>Esp√©cie:</b> <i>", Species, "</i><br>",
"<b>Grupo:</b> ", grupo, "<br>",
"<b>Registros:</b> ", abs(n), "<br>",
"<b>Percentual:</b> ", round(abs(percentual), 2), "%"
)
)) +
geom_col(width = 0.8, color = "white") +
scale_fill_manual(values = c("Epibiontes"="#2E8B57","Basibiontes"="#E74C3C")) +
scale_x_continuous(labels = abs) +
theme_minimal(base_size = 14) +
theme(
axis.text.y = element_text(face = "italic"),
legend.position = "bottom"
)
# converte e limpa tooltips autom√°ticos
g_piramide_interativo <- ggplotly(g_piramide, tooltip = "text",
width = 1000, height = 3000)
for(i in seq_along(g_piramide_interativo$x$data)){
g_piramide_interativo$x$data[[i]]$hoverinfo <- "text"
g_piramide_interativo$x$data[[i]]$text <- g_piramide_interativo$x$data[[i]]$text
}
htmlwidgets::saveWidget(
g_piramide_interativo,
"Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
# ‚úîÔ∏èSALVANDO‚úîÔ∏è
ggsave("Plots/espelhado_spp-contagem.png",
plot = g_piramide_interativo, width = 10, height = 40, dpi = 600, units = "in",
bg = "white" )  # üëà fundo branco garantido)
# gr√°fico base com texto customizado
g_piramide <- ggplot(df_long, aes(
x = n, y = Species, fill = grupo,
text = paste0(
"<b>Esp√©cie:</b> <i>", Species, "</i><br>",
"<b>Grupo:</b> ", grupo, "<br>",
"<b>Registros:</b> ", abs(n), "<br>",
"<b>Percentual:</b> ", round(abs(percentual), 2), "%"
)
)) +
geom_col(width = 0.8, color = "white") +
scale_fill_manual(values = c("Epibiontes"="#2E8B57","Basebiontes"="#E74C3C")) +
scale_x_continuous(labels = abs) +
theme_minimal(base_size = 14) +
theme(
axis.text.y = element_text(face = "italic"),
legend.position = "bottom"
)
# converte e limpa tooltips autom√°ticos
g_piramide_interativo <- ggplotly(g_piramide, tooltip = "text",
width = 1000, height = 3000)
for(i in seq_along(g_piramide_interativo$x$data)){
g_piramide_interativo$x$data[[i]]$hoverinfo <- "text"
g_piramide_interativo$x$data[[i]]$text <- g_piramide_interativo$x$data[[i]]$text
}
htmlwidgets::saveWidget(
g_piramide_interativo,
"Plots/grafico_piramide_spp_interativo.html",
selfcontained = TRUE
)
browseURL("Plots/grafico_piramide_spp_interativo.html")
# TREEMAP - ESP√âCIES UNICAS - TODO PERFEITINHO üß†
setwd("E:/GitHub/GPA-Beatriz/GPA-Beatriz-analises")
getwd()
# BblioteCAS----
library(readr)
library(dplyr)
library(ggplot2)
library(geobr)
library(ggspatial)
library(rnaturalearth)
library(sf)
library(gridExtra)
library(writexl)
library(tidyverse)
library(devtools)
library(rnaturalearthhires)
library(vegan)
library(dplyr)
library(raster)
library(reshape2)
library(extrafont)
library(treemapify)
library(ggplot2)
library(patchwork)
library(RColorBrewer)
df1<- readxl::read_xlsx("Data/COPIA-Database_epizoism_hydroids-bea.xlsx")#‚úîÔ∏è
familias_epi_spp <- df1 %>%
distinct(EP_family, Scientific_name_EP) %>%  # remove duplicatas de esp√©cie dentro da fam√≠lia
count(EP_family, name = "n_epi") %>%    # conta quantas esp√©cies √∫nicas por fam√≠lia
arrange(desc(n_epi))%>%
rename(family = EP_family)  # se j√° for EP_family, use rename(family = EP_family)
familias_base_spp <- df1 %>%
distinct(BS_Family, Scientific_name_EP) %>%  # remove duplicatas de esp√©cie dentro da fam√≠lia
count(BS_Family, name = "n_base") %>%    # conta quantas esp√©cies √∫nicas por fam√≠lia
arrange(desc(n_base))%>%
rename(family = BS_Family)
# --- 1) Padroniza nomes e junta (uni√£o de fam√≠lias) ---‚úîÔ∏è
df <- full_join(familias_base_spp, familias_epi_spp, by = "family") %>%
mutate(across(c(n_epi, n_base), ~replace_na(.x, 0)))
# (opcional) ordenar por total absoluto
df <- df %>%
mutate(total = n_epi + n_base,
family = fct_reorder(family, total, .desc = TRUE))
# --- 2) Long + sinal negativo para basibiontes ---
df_long <- df %>%
pivot_longer(c(n_epi, n_base), names_to = "grupo", values_to = "n") %>%
mutate(
grupo = recode(grupo, n_epi = "Epibiontes", n_base = "basibiontes"),
n = if_else(grupo == "basibiontes", -n, n)
)
df_long <- df_long %>%
group_by(grupo) %>%
mutate(
total_abs = sum(abs(n), na.rm = TRUE),
percentual = 100 * n / total_abs
) %>%
ungroup()
## üé® agora vamos plotar o treemap -----
#install.packages("treemapify")
library(treemapify)
library(ggplot2)
library(patchwork)
library(RColorBrewer)
# todas as fam√≠lias envolvidas‚úîÔ∏è
Species_unicas <- unique(df_long$Species)
# gerar paleta (pode ajustar n de cores conforme necess√°rio)
palette_fam <- setNames(
colorRampPalette(brewer.pal(9, "Set1"))(length(Species_unicas)),
Species_unicas
)
# Separar os dados‚úîÔ∏è
df_epi <- df_long %>% filter(grupo == "Epibiontes", abs(percentual) >= 1.5)
df_base <- df_long %>% filter(grupo == "basibiontes", abs(percentual) >= 1.5)
# 2Ô∏è‚É£ Gerar os treemaps com fill = family e scale_fill_manual(values = palette_fam)
# Epibiontes‚úîÔ∏è
g_epi <- ggplot(df_epi, aes(
area = abs(n),
fill = family,
label = paste0(Species, "\n", abs(n), " (", round(abs(percentual), 1), "%)")
)) +
geom_treemap(color = "white") +
geom_treemap_text(
place = "centre", grow = TRUE, reflow = TRUE,
color = "white", fontface = "bold", size = 10
) +
scale_fill_manual(values = palette_fam) +
labs(title = "Epibiontes") +
theme_minimal() +
theme(legend.position = "none")
# basibiontes‚úîÔ∏è
g_base <- ggplot(df_base, aes(
area = abs(n),
fill = family,
label = paste0(family, "\n", abs(n), " (", round(abs(percentual), 1), "%)")
)) +
geom_treemap(color = "white") +
geom_treemap_text(
place = "centre", grow = TRUE, reflow = TRUE,
color = "white", fontface = "bold", size = 10
) +
scale_fill_manual(values = palette_fam) +
labs(title = "basibiontes") +
theme_minimal() +
theme(legend.position = "none")
#3Ô∏è‚É£ Juntar os dois:
plots_tree<- g_epi + g_base + plot_layout(ncol = 2)
plots_tree
