)
plot(g, layout = lay, asp = 0)
plot(
g,
layout = lay,
vertex.label = V(g)$label,
vertex.label.dist = ifelse(V(g)$type, 0.4, 0.2),
vertex.label.degree = -pi/4
# main = "Rede Epibiontes √ó Fam√≠lias (Bipartida)"
)
lay <- layout_with_fr(
g,
niter = 4000,                     # mais itera√ß√µes = mais ‚Äúarruma‚Äù
area  = (vcount(g)^2) * 20,       # ‚Üë area = espalha
repulserad = (vcount(g)^3) * 10   # ‚Üë repuls√£o = espalha mais
)
plot(g, layout = lay, asp = 0)
plot(
g,
layout = lay,
vertex.label = V(g)$label,
vertex.label.dist = ifelse(V(g)$type, 0.9, 0.2),
vertex.label.degree = -pi/4
# main = "Rede Epibiontes √ó Fam√≠lias (Bipartida)"
)
lay <- layout_with_fr(
g,
niter = 4000,                     # mais itera√ß√µes = mais ‚Äúarruma‚Äù
area  = (vcount(g)^2) * 20,       # ‚Üë area = espalha
repulserad = (vcount(g)^3) * 10   # ‚Üë repuls√£o = espalha mais
)
plot(g, layout = lay, asp = 0)
plot(
g,
layout = lay,
vertex.label = V(g)$label,
vertex.label.dist = ifelse(V(g)$type, 1.1, 0.2),
vertex.label.degree = -pi/4
# main = "Rede Epibiontes √ó Fam√≠lias (Bipartida)"
)
lay <- layout_with_fr(
g,
niter = 4000,                     # mais itera√ß√µes = mais ‚Äúarruma‚Äù
area  = (vcount(g)^2) * 20,       # ‚Üë area = espalha
repulserad = (vcount(g)^3) * 10   # ‚Üë repuls√£o = espalha mais
)
plot(g, layout = lay, asp = 0)
plot(
g,
layout = lay,
vertex.label = V(g)$label,
vertex.label.dist = ifelse(V(g)$type, 4, 0.2),
vertex.label.degree = -pi/4
# main = "Rede Epibiontes √ó Fam√≠lias (Bipartida)"
)
lay <- layout_with_fr(
g,
niter = 4000,                     # mais itera√ß√µes = mais ‚Äúarruma‚Äù
area  = (vcount(g)^2) * 20,       # ‚Üë area = espalha
repulserad = (vcount(g)^3) * 10   # ‚Üë repuls√£o = espalha mais
)
plot(g, layout = lay, asp = 0)
par(mar = c(0, 0, 0, 0))
lay_zoom <- lay * 6
svg("rede_epibiontes3.svg", width = 16, height = 14)
dev.off()
dev.off()
dev.off()
plot(
g,
layout = lay,
vertex.label = V(g)$label,
vertex.label.dist = ifelse(V(g)$type, 4, 0.2),
vertex.label.degree = -pi/4
# main = "Rede Epibiontes √ó Fam√≠lias (Bipartida)"
)
lay <- layout_with_fr(
g,
niter = 4000,                     # mais itera√ß√µes = mais ‚Äúarruma‚Äù
area  = (vcount(g)^2) * 20,       # ‚Üë area = espalha
repulserad = (vcount(g)^3) * 10   # ‚Üë repuls√£o = espalha mais
)
plot(g, layout = lay, asp = 0)
par(mar = c(0, 0, 0, 0))
lay_zoom <- lay * 6
svg("rede_epibiontes3.svg", width = 16, height = 14)
dev.off()
setwd("E:/GitHub/GPA-Beatriz/GPA-Beatriz-analises")
getwd()
# Pacotes
library(dplyr)
library(tidyr)
library(readr)
library(igraph)
library(bipartite)
# Se voc√™ est√° lendo do GitHub:
# url <- "https://raw.githubusercontent.com/SEU_USER/SEU_REPO/main/Data/epibiontes-familiabase.csv"
# df_raw <- read_csv(url, show_col_types = FALSE)
df_raw<-read.csv("Data/epibiontes-familiabase-tab.csv")
unique(df_raw$Scientific_name_EP)
head(df_raw)
nomes_separados <- separate(df_raw,
col = "Scientific_name_EP",
into = c("genero", "especifico"),
sep = " ")
nomes_separados <- nomes_separados %>%
mutate(
genero_inicial = paste0(substr(genero, 1, 1), "."),
nome_abrev = if_else(
is.na(especifico) | especifico == "",
genero,
paste(genero_inicial, especifico)
)
)
head(nomes_separados)
df_modif<-nomes_separados%>%
select(nome_abrev, BS_Family, n)
unique(nomes_separados$BS_Family)
# Nomes das colunas do seu dataframe:
# (troque aqui se necess√°rio)
COL_FAMILIA <- "basibionte_family"   # ex: "BS_Family" ou "Family_base"
COL_ESPECIE <- "nome_abrev"   # ex: "Scientific_name_EP" ou "Species_epi"
COL_WEIGHT  <- "n"                 # se voc√™ j√° tem contagem numa coluna (ex: "n"), coloque "n"
df1 <- df_modif %>%
# garante que as colunas existem
rename(
familia = all_of("BS_Family"),
especie = all_of("nome_abrev")
)%>%
# remove NAs e strings vazias
filter(
!is.na(familia), !is.na(especie),
familia != "", especie != ""
) # mudou de nome mas √± verificou celulas NA
if (is.null(COL_WEIGHT)) {
# Conta ocorr√™ncias (cada linha = uma ocorr√™ncia)
mat_df <- df1 %>%
count(familia, especie, name = "weight")
} else {
# Soma pesos (caso j√° exista uma coluna com valores)
mat_df <- df1 %>%
mutate(weight = as.numeric(.data[[COL_WEIGHT]])) %>%
filter(!is.na(weight)) %>%
group_by(familia, especie) %>%
summarise(weight = sum(weight), .groups = "drop")
}
# Pivot para matriz (fam√≠lia nas linhas, esp√©cie nas colunas)
m <- mat_df %>%
pivot_wider(
names_from = especie,
values_from = weight,
values_fill = 0
) %>%
as.data.frame()
# primeira coluna = nomes das fam√≠lias
rownames(m) <- m$familia
m$familia <- NULL
# vira matriz e for√ßa num√©rico
m <- as.matrix(m)
storage.mode(m) <- "numeric"
# remove linhas/colunas totalmente zeradas (boa pr√°tica)
m <- m[rowSums(m) > 0, colSums(m) > 0, drop = FALSE]
# checagens r√°pidas
stopifnot(!is.null(rownames(m)))
stopifnot(!is.null(colnames(m)))
stopifnot(is.numeric(m[1, 1]))
edges <- which(m > 0, arr.ind = TRUE)
g <- graph_from_data_frame(df_edges, directed = FALSE)
plot(g)
edges <- which(m > 0, arr.ind = TRUE)
df_edges <- data.frame(
from   = rownames(m)[edges[, 1]],        # fam√≠lias
to     = colnames(m)[edges[, 2]],        # esp√©cies
weight = as.numeric(m[edges]),           # peso da intera√ß√£o
row.names = NULL
)
g <- graph_from_data_frame(df_edges, directed = FALSE)
plot(g)
# marca tipos (bipartido) para layout/plot
V(g)$type <- V(g)$name %in% df_edges$to  # TRUE = esp√©cies, FALSE = fam√≠lias
library(igraph)
#========================
# 1) Matriz limpa
#========================
m2 <- m[rowSums(m) > 0, colSums(m) > 0, drop = FALSE]
# (opcional, mas seguro) garantir numeric
storage.mode(m2) <- "numeric"
m2[is.na(m2)] <- 0
familias <- rownames(m2)
especies <- colnames(m2)
#========================
# 2) Edges: esp√©cie -> fam√≠lia
#========================
edges <- which(m2 > 0, arr.ind = TRUE)
df_edges <- data.frame(
from   = especies[edges[,2]],   # esp√©cie
to     = familias[edges[,1]],   # fam√≠lia
weight = m2[edges]
)
df_edges$weight <- as.numeric(df_edges$weight)
g <- graph_from_data_frame(df_edges, directed = TRUE)
#========================
# 3) Biparti√ß√£o robusta
#========================
V(g)$type <- V(g)$name %in% familias   # TRUE = fam√≠lias / FALSE = esp√©cies
V(g)$group <- ifelse(V(g)$type, "familia", "especie")
#========================
# 4) Pesos e for√ßa
#========================
E(g)$weight <- df_edges$weight
# for√ßa ponderada
V(g)$strength <- strength(g, weights = E(g)$weight)
# for√ßa ponderada
V(g)$strength <- igraph::graph.strength(g)
# for√ßa ponderada
V(g)$strength <- igraph::graph.strength(g)
max_strength <- max(V(g)$strength, na.rm = TRUE)
if (!is.finite(max_strength) || max_strength == 0) max_strength <- 1
max_w <- max(E(g)$weight, na.rm = TRUE)
if (!is.finite(max_w) || max_w == 0) max_w <- 1
#========================
# 5) Est√©tica: n√≥s
#========================
# cores com transpar√™ncia
V(g)$color <- NA
V(g)$color[V(g)$type]  <- adjustcolor("salmon",  alpha.f = 0.85)  # fam√≠lias
V(g)$color[!V(g)$type] <- adjustcolor("#457b9d", alpha.f = 0.40)  # esp√©cies
# borda suave (ou sem borda)
V(g)$frame.color <- NA
V(g)$frame.width <- 0
# tamanhos (comprimidos com sqrt pra n√£o virar bola gigante)
# fam√≠lias um pouco maiores, esp√©cies menores
V(g)$size <- ifelse(
V(g)$type,
6 + 7 * sqrt(V(g)$strength / max_strength),   # fam√≠lias
3 + 4 * sqrt(V(g)$strength / max_strength)    # esp√©cies
)
#========================
# 6) Est√©tica: arestas e setas
#========================
E(g)$color <- adjustcolor("red", alpha.f = 0.22)
E(g)$curved <- 0.12
w_norm <- sqrt(E(g)$weight / max_w)
E(g)$width <- 0.2 + 1.8 * w_norm
E(g)$arrow.size  <- 0.35
E(g)$arrow.width <- 0.6
#========================
# 7) R√≥tulos (s√≥ top N)
#========================
top_labels <- 28
keep <- order(V(g)$strength, decreasing = TRUE)[1:min(top_labels, vcount(g))]
V(g)$label <- NA
V(g)$label[keep] <- V(g)$name[keep]
# it√°lico apenas para esp√©cies
V(g)$label.font <- ifelse(V(g)$type, 1, 3)
V(g)$label.cex <- ifelse(V(g)$type, 0.75, 0.55)
V(g)$label.color <- ifelse(V(g)$type, "black", "navy")
# dist√¢ncia do r√≥tulo: fam√≠lias mais afastadas
label_dist <- ifelse(V(g)$type, 1.4, 0.6)
#========================
# 8) Layout (uma vez s√≥, com repuls√£o)
#========================
set.seed(42)
lay <- layout_with_fr(
g,
niter = 5000,
area = (vcount(g)^2) * 35,
repulserad = (vcount(g)^3) * 18
)
# se quiser ‚Äúespalhar‚Äù mais sem recalcular:
lay <- lay * 1.8
#========================
# 9) Plot na tela
#========================
par(mar = c(0, 0, 0, 0))
plot(
g,
layout = lay,
vertex.label.dist = label_dist,
vertex.label.degree = -pi/6,
asp = 0
)
# dist√¢ncia do r√≥tulo: fam√≠lias mais afastadas
label_dist <- ifelse(V(g)$type, 0.9, 0.35)
#========================
# 8) Layout (uma vez s√≥, com repuls√£o)
#========================
set.seed(42)
lay <- layout_with_fr(
g,
niter = 5000,
area = (vcount(g)^2) * 35,
repulserad = (vcount(g)^3) * 18
)
# se quiser ‚Äúespalhar‚Äù mais sem recalcular:
lay <- lay * 1.8
#========================
# 9) Plot na tela
#========================
par(mar = c(0, 0, 0, 0))
plot(
g,
layout = lay,
vertex.label.dist = label_dist,
vertex.label.degree = -pi/6,
asp = 0
)
V(g)$label <- V(g)$name   # mostra TODOS (fam√≠lias + esp√©cies)
# it√°lico apenas para esp√©cies
V(g)$label.font <- ifelse(V(g)$type, 1, 3)
V(g)$label.cex <- ifelse(V(g)$type, 0.75, 0.55)
V(g)$label.color <- ifelse(V(g)$type, "black", "navy")
# dist√¢ncia do r√≥tulo: fam√≠lias mais afastadas
label_dist <- ifelse(V(g)$type, 0.9, 0.35)
#========================
# 8) Layout (uma vez s√≥, com repuls√£o)
#========================
set.seed(42)
lay <- layout_with_fr(
g,
niter = 5000,
area = (vcount(g)^2) * 35,
repulserad = (vcount(g)^3) * 18
)
# se quiser ‚Äúespalhar‚Äù mais sem recalcular:
lay <- lay * 1.8
#========================
# 9) Plot na tela
#========================
par(mar = c(0, 0, 0, 0))
plot(
g,
layout = lay,
vertex.label.dist = label_dist,
vertex.label.degree = -pi/6,
asp = 0
)
#========================
# 10) Salvar (SEM SVG vazio)
#========================
# SVG
svg("rede_bipartida.svg", width = 12, height = 7)
par(mar = c(0, 0, 0, 0))
plot(
g,
layout = lay,
vertex.label.dist = label_dist,
vertex.label.degree = -pi/6,
asp = 0
)
dev.off()
quit()
View(df_raw)
head(df_modif)
df_modif |> pivot_wider(names_from = "BS_Family",
values_from = "n")
library(tidyr)
head(df_modif)
df_modif |> pivot_wider(names_from = "BS_Family",
values_from = "n")
df_modif |>
pivot_wider(
names_from  = BS_Family,
values_from = n,
values_fill = 0
)
#teste de qui-quadrado
chisq.test(df_modif)
#teste de qui-quadrado
res <- chisq.test(mat)
#teste de qui-quadrado
res <- chisq.test(df_modif)
res$expected
View(df_modif)
df_modif |>
pivot_wider(
names_from  = BS_Family,
values_from = n,
values_fill = 0# enche os na de zeros
)
df_test<-df_modif |>
pivot_wider(
names_from  = BS_Family,
values_from = n,
values_fill = 0# enche os na de zeros
)
#teste de qui-quadrado
res <- chisq.test(df_test)
res$expected
mat <- df_modif |>
pivot_wider(
names_from  = BS_Family,
values_from = n,
values_fill = 0
)
mat_num <- mat |>
select(-Scientific_name_EP)
head(mat)
mat_num <- mat |>
select(-nome_abrev)
mat_num <- mat |>
select(-nome_abrev)
library(tidyr)
mat_num <- mat |>
select(-nome_abrev)
mat_num <- as.matrix(mat[ , -1])
mat_num
#teste de qui-quadrado
res <- chisq.test(mat_num)
res$expected |> summary()
sum(res$expected < 5)
sum(res$expected < 1)
mean(res$expected < 5)  # propor√ß√£o
# teste de fisher
fisher.test(mat_num)
fisher.test(mat_num, simulate.p.value = TRUE, B = 10000)
#qui-quadrado
chisq.test(mat_num, simulate.p.value = TRUE, B = 10000)
# Se voc√™ est√° lendo do GitHub:
# url <- "https://raw.githubusercontent.com/SEU_USER/SEU_REPO/main/Data/epibiontes-familiabase.csv"
# df_raw <- read_csv(url, show_col_types = FALSE)
df_raw<-read.csv("Data/epibiontes-familiabase-tab.csv")
library(dplyr)
library(tidyr)
library(readr)
head(df_raw)
nomes_separados <- separate(df_raw,
col = "Scientific_name_EP",
into = c("genero", "especifico"),
sep = " ")
head(nomes_separados)
nomes_separados <- nomes_separados %>%
mutate(
genero_inicial = paste0(substr(genero, 1, 1), ".")
)
head(nomes_separados)
nomes_separados <- nomes_separados %>%
mutate(nome_abrev = if_else(
is.na(especifico) | especifico == "",
genero,
paste(genero_inicial, especifico)
)
)
> head(nomes_separados)
head(nomes_separados)
nomes_separados <- separate(df_raw,
col = "Scientific_name_EP",
into = c("genero", "especifico"),
sep = " ")
nomes_separados <- nomes_separados %>%
mutate(
genero_inicial = paste0(substr(genero, 1, 1), "."),
nome_abrev = if_else(
is.na(especifico) | especifico == "",
genero,
paste(genero_inicial, especifico)
)
)
setwd("E:/GitHub/GPA-Beatriz/GPA-Beatriz-analises")
getwd()
# BblioteCAS----
library(readr)
library(sf)
library(writexl)
library(tidyverse)
library(devtools)
library(vegan)
library(reshape2)
df1<- readxl::read_xlsx("Data/COPIA-Database_epizoism_hydroids-bea.xlsx")
colnames(df1
)
head(df1)
df2<-dplyr::select(df1,"Scientific_name_EP", "EP_family", "Scientific_name_BS","BS_Family")
head(df2)
df_long <- df1 |>
select(EP_family, BS_Family) |>
pivot_longer(
cols = c(EP_family, BS_Family),
names_to = "role",
values_to = "family"
) |>
mutate(
role = ifelse(role == "EP_family", "Epibionte", "Basibionte")
)
View(df_long)
head(df_long)
df_long1 <- df_long |>
pivot_longer(cols=c("Basibionte", "Epibionte"),
names_to = "role",
values_to = "scores")
#contar
df_count <- df_long |>
count(family, role)
View(df_count)
View(df_count)
df_wider <- df_count |>
pivot_wider(names_from  = role,
values_from = n,
values_fill = 0)
View(df_wider)
head
head(df_wider)
# Matriz para o teste
mat_num <- mat_fam |>
column_to_rownames("family") |>
as.matrix()
mat_num <- df_wider |>
column_to_rownames("family") |>
as.matrix()
View(mat_num)
# üß™ Teste
fisher.test(mat_num, simulate.p.value = TRUE, B = 10000)
