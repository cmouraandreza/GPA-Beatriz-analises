# scater plot
#1.10.2025

setwd("E:/GitHub/GPA-Beatriz/GPA-Beatriz-analises")
getwd()

# BblioteCAS----
library(readr)
library(ggplot2)
library(sf)
library(writexl)
library(tidyverse)
library(devtools)
library(vegan)
library(dplyr)
library(extrafont)

New.data<- readxl::read_xlsx("Data/atualizadada-Database_epizoism_hydroids X basibionts PARA AN√ÅLISE EPI e BASI.xlsx")


EpiHydSpe
EpiHydFam

BasHydSpe
BasHydFam

df1 <- New.data %>%
  mutate(
    Genus_EP = word(EpiHydSpe, 1),
    Genus_BS = word(BasHydSpe, 1)
  )%>%
rename(
  Family_EP= EpiHydFam,
  Family_BS = BasHydFam
)



colnames(New.data)

EP-family
EP-Genera
Genera-BS
Family-BS<-BasHydFam



#familias e generos-----
familias_epi <- df1 %>%
  count(Family_EP, name = "frequencia") %>%   # conta por fam√≠lia
  arrange(desc(frequencia))     
familias_base <- df1 %>%
  count(Family_BS, name = "frequencia") %>%   # conta por fam√≠lia
  arrange(desc(frequencia))
# generos
generos_epi <- df1 %>%
  count(Genus_EP, name = "frequencia") %>%   # conta por genero
  arrange(desc(frequencia))
generos_base <- df1 %>%
  count(Genus_BS, name = "frequencia") %>%   # conta por genero
  arrange(desc(frequencia))



writexl::write_xlsx(df1, "Data/dados-atualizados-bea-janeiro26.xlsx")

# agora eu quero pelo numero de esp√©cies unicas ------

# EPI-SPP UNI

familias_epi_especies <- df1 %>%
  distinct(Family_EP, EpiHydSpe) %>%         # remove duplicatas da combina√ß√£o
  count(Family_EP, name = "n_especies") %>%   # conta quantas esp√©cies √∫nicas por fam√≠lia
  arrange(desc(n_especies))

#LISTA DE ESP√âCIES ----
list_spp<-df1 %>% 
  distinct(EpiHydSpe)

# BASE-SPP UNI
familias_base_especies <- df1 %>%
  distinct(Family_BS, BasHydSpe) %>%         # remove duplicatas da combina√ß√£o
  count(Family_BS, name = "n_especies") %>%   # conta quantas esp√©cies √∫nicas por fam√≠lia
  arrange(desc(n_especies))

list_spp_base<-df1 %>% 
  distinct(BasHydSpe)


# criando o mesmo df para generos -------

#antes de prosseguir com as an√°lises mesmo

# BASE-SPP UNI

generos_epi <- df1 %>%
  count(Genus_EP, name = "frequencia") %>%   # conta por genero
  arrange(desc(frequencia))

generos_base <- df1 %>%
  count(Genus_BS, name = "frequencia") %>%   # conta por genero
  arrange(desc(frequencia))



generos_base_especies <- df1 %>%
  distinct(Genus_BS, BasHydSpe) %>%         # remove duplicatas da combina√ß√£o
  count(Genus_BS, name = "n_especies") %>%   # conta quantas esp√©cies √∫nicas por fam√≠lia
  arrange(desc(n_especies))


generos_epi_especies <- df1 %>%
  distinct(Genus_EP, EpiHydSpe) %>%         # remove duplicatas da combina√ß√£o
  count(Genus_EP, name = "n_especies") %>%   # conta quantas esp√©cies √∫nicas por fam√≠lia
  arrange(desc(n_especies))


#   familias_base: colunas  Family_BS                  + frequencia----

epi  <- familias_epi  %>%
  rename(family = Family_EP, n_epi = frequencia)  # se j√° for Family_EP, use rename(family = Family_EP)
base <- familias_base %>%
  rename(family = Family_BS,  n_base = frequencia)

df <- full_join(epi, base, by = "family") %>%
  mutate(across(c(n_epi, n_base), ~replace_na(.x, 0)))

# (opcional) ordenar por total absoluto
df <- df %>%
  mutate(total = n_epi + n_base,
         family = fct_reorder(family, total, .desc = TRUE))

#escreve varias pastas do arquivo <3----

writexl::write_xlsx(
  list(
    "Resumo-frequencia-fam" = df,
    "spp-fam-epi" = list_spp,
    "num-spp-fam-epi"=familias_epi_especies,
    "spp-fam-base"=list_spp_base,
    "num-spp-fam-base"=familias_base_especies,
    "spp-gen-epi"=  generos_epi_especies,
    "spp-gen-base"=  generos_base_especies
    
  ),
  path = "data/fam-gen-freq-contg.xlsx"
)



#-----------------------------------------------------------------------------#
#
#                               PULE PARA C√Å                                  #
#                           E PLOTFY KKKKK                                    #



# 3. Plotando o grafico  comum ----


library(ggplot2)
library(forcats)  # pra usar fct_reorder()

plot.fam.base  <- familias_base%>%
  dplyr::filter(frequencia > 1) %>%   # üëà remove g√™neros com frequ√™ncia 1
       
  ggplot( aes(
  y = frequencia,
  x = fct_reorder(Family_BS, frequencia)  # ordena pela frequ√™ncia
)) + 
  geom_bar(
    position = "stack", stat = "identity", size = 0.4
  ) +
  labs(y = "Fam√≠lias de hidroides basibiontes", x = "Fam√≠lia") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    rect = element_blank(),
    text = element_text(size = 14),
    legend.position = "top"
  ) +
  geom_text(
    aes(label = ifelse(round(frequencia, 1) > 1,
                       paste0(round(frequencia, 1)), "")), 
    size = 4, 
    position = position_stack(vjust = 0.5), 
    color = "white"
  ) +
  coord_flip()  # deixa as barras horizontais

plot.fam.base

#guardando
png(
  filename = "Plots/fam_basi.png",
  width = 10,
  height = 12,
  units = "in",
  res = 300
)

plot.fam.base   # ou print(plot.fam.base) se for ggplot

dev.off()
#plot com familias----


plot.fam.epi <- familias_epi%>%
  dplyr::filter(frequencia > 1) %>%   # üëà remove g√™neros com frequ√™ncia 1
  ggplot( aes( y = frequencia,
               x = fct_reorder(Family_EP, frequencia)  # ordena pela frequ√™ncia
)) + 
  geom_bar(
    position = "stack", stat = "identity", size = 0.4
  ) +
  labs(y = "Fam√≠lias de hidroides epibiontes", x = "Family") +
#  title("Basebionts Families")+
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    rect = element_blank(),
    text = element_text(size = 14),
    legend.position = "top"
  )+
  geom_text(
    aes(label = ifelse(round(frequencia, 1) > 1,
                       paste0(round(frequencia, 1)), "")), 
    size = 4, 
    position = position_stack(vjust = 0.5), 
    color = "white"
  )+ coord_flip()
plot.fam.epi


#guardando
png(
  filename = "Plots/fam_epi.png",
  width = 10,
  height = 12,
  units = "in",
  res = 300
)

plot.fam.epi   # ou print(plot.fam.base) se for ggplot

dev.off()







# pplotando generos -----



plot.gen.epi <- generos_epi_especies %>%
  dplyr::filter(n_especies > 1) %>%   # üëà remove g√™neros com frequ√™ncia 1
  ggplot(aes(
    y = n_especies,
    x = fct_reorder(Genus_EP, n_especies)
  )) + 
  geom_bar(
    position = "stack", stat = "identity", size = 0.4
  ) +
  labs(y = "G√™neros de hidroides epibiontes", x = "G√™neros") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    rect = element_blank(),
    text = element_text(size = 14),
    legend.position = "top"
  ) +
  geom_text(
    aes(label = ifelse(n_especies > 1, n_especies, "")),
    size = 4,
    position = position_stack(vjust = 0.5),
    color = "white"
  ) +
  coord_flip()



#guardando
png(
  filename = "Plots/gen_epi.png",
  width = 10,
  height = 12,
  units = "in",
  res = 300
)

plot.gen.epi   # ou print(plot.fam.base) se for ggplot

dev.off()


# plot de genero para base
plot.gen.basi <- generos_base_especies %>%
  dplyr::filter(n_especies > 1) %>%   # üëà remove g√™neros com frequ√™ncia 1
  ggplot(aes(
    y = n_especies,
    x = fct_reorder(Genus_BS, n_especies)
  )) + 
  geom_bar(
    position = "stack", stat = "identity", size = 0.4
  ) +
  labs(y = "G√™neros de hidroides basibiontes", x = "G√™neros") +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    rect = element_blank(),
    text = element_text(size = 14),
    legend.position = "top"
  ) +
  geom_text(
    aes(label = ifelse(n_especies > 1, n_especies, "")),
    size = 4,
    position = position_stack(vjust = 0.5),
    color = "white"
  ) +
  coord_flip()

plot.gen.basi

#guardando
png(
  filename = "Plots/plot.gen.basi.png",
  width = 10,
  height = 12,
  units = "in",
  res = 300
)

plot.gen.basi   # ou print(plot.fam.base) se for ggplot

dev.off()




