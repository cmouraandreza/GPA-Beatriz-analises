# TREEMAP - ESP√âCIES UNICAS - TODO PERFEITINHO üß†

setwd("E:/GitHub/GPA-Beatriz/GPA-Beatriz-analises")
getwd()

# BblioteCAS----
library(readr)
library(dplyr)
library(ggplot2)
library(geobr)
library(ggspatial)
library(rnaturalearth)
library(sf)
library(gridExtra)
library(writexl)
library(tidyverse)
library(devtools)
library(rnaturalearthhires)
library(vegan)
library(dplyr)
library(raster)
library(reshape2)
library(extrafont)
library(treemapify)
library(patchwork)
library(RColorBrewer)


df1<- readxl::read_xlsx("Data/COPIA-Database_epizoism_hydroids-bea.xlsx")#‚úîÔ∏è


### FAMILIAS ------
familias_epi_spp <- df1 %>%
  distinct(EP_family, Scientific_name_EP) %>%  # remove duplicatas de esp√©cie dentro da fam√≠lia
  count(EP_family, name = "n_epi") %>%    # conta quantas esp√©cies √∫nicas por fam√≠lia
  arrange(desc(n_epi))%>%
  rename(family = EP_family)  # se j√° for EP_family, use rename(family = EP_family)

familias_base_spp <- df1 %>%
  distinct(BS_Family, Scientific_name_EP) %>%  # remove duplicatas de esp√©cie dentro da fam√≠lia
  count(BS_Family, name = "n_base") %>%    # conta quantas esp√©cies √∫nicas por fam√≠lia
  arrange(desc(n_base))%>%
  rename(family = BS_Family)



# --- 1) Padroniza nomes e junta (uni√£o de fam√≠lias) ---‚úîÔ∏è


df <- full_join(familias_base_spp, familias_epi_spp, by = "family") %>%
  mutate(across(c(n_epi, n_base), ~replace_na(.x, 0)))

# (opcional) ordenar por total absoluto
df <- df %>%
  mutate(total = n_epi + n_base,
         family = fct_reorder(family, total, .desc = TRUE))

# --- 2) Long + sinal negativo para basebiontes ---
df_long <- df %>%
  pivot_longer(c(n_epi, n_base), names_to = "grupo", values_to = "n") %>%
  mutate(
    grupo = recode(grupo, n_epi = "Epibiontes", n_base = "Basebiontes"),
    n = if_else(grupo == "Basebiontes", -n, n)
  )

df_long <- df_long %>%
  group_by(grupo) %>%
  mutate(
    total_abs = sum(abs(n), na.rm = TRUE),
    percentual = 100 * n / total_abs
  ) %>%
  ungroup()

## üé® agora vamos plotar o treemap ----

#install.packages("treemapify")
library(treemapify)
library(ggplot2)
library(patchwork)
library(RColorBrewer)

# todas as fam√≠lias envolvidas‚úîÔ∏è
Species_unicas <- unique(df_long$family)

# gerar paleta (pode ajustar n de cores conforme necess√°rio)
palette_fam <- setNames(
  colorRampPalette(brewer.pal(9, "Set1"))(length(Species_unicas)),
  Species_unicas
)

# Separar os dados‚úîÔ∏è
df_epi <- df_long %>% filter(grupo == "Epibiontes", abs(percentual) >= 1.5)
df_base <- df_long %>% filter(grupo == "Basebiontes", abs(percentual) >= 1.5)

# 2Ô∏è‚É£ Gerar os treemaps com fill = family e scale_fill_manual(values = palette_fam)
# Epibiontes‚úîÔ∏è
g_epi <- ggplot(df_epi, aes(
  area = abs(n),
  fill = family,
  label = paste0(family, "\n", abs(n), " (", round(abs(percentual), 1), "%)")
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    place = "centre", grow = TRUE, reflow = TRUE,
    color = "white", fontface = "bold", size = 10
  ) +
  scale_fill_manual(values = palette_fam) +
  labs(title = "Epibiontes") +
  theme_minimal() +
  theme(legend.position = "none")

# Basebiontes‚úîÔ∏è
g_base <- ggplot(df_base, aes(
  area = abs(n),
  fill = family,
  label = paste0(family, "\n", abs(n), " (", round(abs(percentual), 1), "%)")
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    place = "centre", grow = TRUE, reflow = TRUE,
    color = "white", fontface = "bold", size = 10
  ) +
  scale_fill_manual(values = palette_fam) +
  labs(title = "Basebiontes") +
  theme_minimal() +
  theme(legend.position = "none")

#3Ô∏è‚É£ Juntar os dois:
plots_tree<- g_epi + g_base + plot_layout(ncol = 2)
plots_tree



# ‚úîÔ∏èSALVANDO‚úîÔ∏è
#ggsave("Plots/treemap_sppunica-contagem.png",
 #      plot = plots_tree, width = 14, height = 8, dpi = 600, units = "in")
####

### G√äNEROS ----
colnames(df1)


gen_epi_spp <- df1 %>%
  distinct(EP_Genera, Scientific_name_EP) %>%  # remove duplicatas de esp√©cie dentro da fam√≠lia
  count(EP_Genera, name = "n_epi") %>%    # conta quantas esp√©cies √∫nicas por fam√≠lia
  arrange(desc(n_epi))%>%
  rename(Genera = EP_Genera)  # se j√° for EP_family, use rename(family = EP_family)

gen_base_spp <- df1 %>%
  distinct(BS_Genera, Scientific_name_EP) %>%  # remove duplicatas de esp√©cie dentro da fam√≠lia
  count(BS_Genera, name = "n_base") %>%    # conta quantas esp√©cies √∫nicas por fam√≠lia
  arrange(desc(n_base))%>%
  rename(Genera = BS_Genera)



# --- 1) Padroniza nomes e junta (uni√£o de generos) ---‚úîÔ∏è


df <- full_join(gen_base_spp, gen_epi_spp, by = "Genera") %>%
  mutate(across(c(n_epi, n_base), ~replace_na(.x, 0)))

# (opcional) ordenar por total absoluto
df <- df %>%
  mutate(total = n_epi + n_base,
         Genera = fct_reorder(Genera, total, .desc = TRUE))

# --- 2) Long + sinal negativo para basebiontes ---
df_long <- df %>%
  pivot_longer(c(n_epi, n_base), names_to = "grupo", values_to = "n") %>%
  mutate(
    grupo = recode(grupo, n_epi = "Epibiontes", n_base = "Basebiontes"),
    n = if_else(grupo == "Basebiontes", -n, n)
  )



df_long <- df_long %>%
  mutate(n_abs = abs(n)) %>%
  group_by(grupo) %>%
  mutate(
    total_grupo = sum(n_abs, na.rm = TRUE),
    percentual = 100 * n_abs / total_grupo
  ) %>%
  ungroup()

## üé® agora vamos plotar o treemap ----

#install.packages("treemapify")
library(treemapify)
library(ggplot2)
library(patchwork)
library(RColorBrewer)

# todas as fam√≠lias envolvidas‚úîÔ∏è
Species_unicas <- unique(df_long$Genera)

# gerar paleta (pode ajustar n de cores conforme necess√°rio)
palette_gen <- setNames(
  colorRampPalette(brewer.pal(9, "Set1"))(length(Species_unicas)),
  Species_unicas
)

# Separar os dados‚úîÔ∏è
df_epi <- df_long %>% filter(grupo == "Epibiontes", abs(percentual) >= 1.5)
df_base <- df_long %>% filter(grupo == "Basebiontes", abs(percentual) >= 1.5)

# 2Ô∏è‚É£ Gerar os treemaps com fill = family e scale_fill_manual(values = palette_fam)
# Epibiontes‚úîÔ∏è
g_epi <- ggplot(df_epi, aes(
  area = abs(n),
  fill = Genera,
  label = paste0(Genera, "\n", abs(n), " (", round(abs(percentual), 1), "%)")
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    place = "centre", grow = TRUE, reflow = TRUE,
    color = "white", fontface = "bold", size = 10
  ) +
  scale_fill_manual(values = palette_gen) +
  labs(title = "Epibiontes") +
  theme_minimal() +
  theme(legend.position = "none")

# Basebiontes‚úîÔ∏è
g_base <- ggplot(df_base, aes(
  area = abs(n),
  fill = Genera,
  label = paste0(Genera, "\n", abs(n), " (", round(abs(percentual), 1), "%)")
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    place = "centre", grow = TRUE, reflow = TRUE,
    color = "white", fontface = "bold", size = 10
  ) +
  scale_fill_manual(values = palette_gen) +
  labs(title = "Basibiontes") +
  theme_minimal() +
  theme(legend.position = "none")

#3Ô∏è‚É£ Juntar os dois:
plots_tree<- g_epi + g_base + plot_layout(ncol = 2)
plots_tree



# ‚úîÔ∏èSALVANDO‚úîÔ∏è
#ggsave("Plots/treemap_generos-contagem.png",
 #      plot = plots_tree, width = 14, height = 8, dpi = 600, units = "in")


### ESP√âCIES ----

colnames(df1)

epi_spp_count <- df1 %>%
  count(Scientific_name_EP, name = "n_epi") %>%  # conta quantas vezes cada esp√©cie aparece
  arrange(desc(n_epi))  %>%
  rename(Species = Scientific_name_EP)  # se j√° for EP_family, use rename(family = EP_family)
                         # ordena da mais frequente pra menos

base_spp_count <- df1 %>%
  count(Scientific_name_BS, name = "n_base") %>%  # conta quantas vezes cada esp√©cie aparece
  arrange(desc(n_base))%>%
  rename(Species = Scientific_name_BS)   

#

# --- 1) Padroniza nomes e junta (uni√£o de spp) ---‚úîÔ∏è----

df <- full_join(epi_spp_count, base_spp_count, by = "Species") %>%
  mutate(across(c(n_epi, n_base), ~replace_na(.x, 0)))



# fazemos a porcentagem%
df_cont <- df %>%
  group_by(grupo) %>%
  mutate(
    total_abs = sum(abs(n), na.rm = TRUE),
    percentual = 100 * n / total_abs
  ) %>%
  ungroup()# esse nao ta funcionando
#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

# cria uma c√≥pia com percentual absoluto
df_long_excel <- df_long %>%
  mutate(percentual = abs(percentual))  # deixa todos os percentuais positivos

#salvando algum bagulho
#writexl::write_xlsx(df_long_excel, "especies_contagem.xlsx")


# (opcional) ordenar por total absoluto
df <- df %>%
  mutate(total = n_epi + n_base,
         Species = fct_reorder(Species, total, .desc = TRUE))

# --- 2) Long + sinal negativo para basebiontes ---
df_long <- df %>%
  pivot_longer(c(n_epi, n_base), names_to = "grupo", values_to = "n") %>%
  mutate(
    grupo = recode(grupo, n_epi = "Epibiontes", n_base = "Basebiontes"),
    n = if_else(grupo == "Basebiontes", -n, n)
  )

# fazemos a porcentagem%
df_long <- df_long %>%
  group_by(grupo) %>%
  mutate(
    total_abs = sum(abs(n), na.rm = TRUE),
    percentual = 100 * n / total_abs
  ) %>%
  ungroup()



## üé® agora vamos plotar o treemap ----

#install.packages("treemapify")
library(treemapify)
library(ggplot2)
library(patchwork)
library(RColorBrewer)

# todas as fam√≠lias envolvidas‚úîÔ∏è
Species_unicas <- unique(df_long$Species)

# gerar paleta (pode ajustar n de cores conforme necess√°rio)
palette_fam <- setNames(
  colorRampPalette(brewer.pal(9, "Set1"))(length(Species_unicas)),
  Species_unicas
)

# Separar os dados‚úîÔ∏è
df_epi <- df_long %>% filter(grupo == "Epibiontes", abs(percentual) >= 1.5)
df_base <- df_long %>% filter(grupo == "Basebiontes", abs(percentual) >= 1.5)

# 2Ô∏è‚É£ Gerar os treemaps com fill = family e scale_fill_manual(values = palette_fam)


# Epibiontes‚úîÔ∏è
g_epi <- ggplot(df_epi, aes(
  area = abs(n),
  fill = Species,
  label = paste0(Species, "\n", abs(n), " (", round(abs(percentual), 1), "%)")
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    place = "centre", grow = TRUE, reflow = TRUE,
    color = "white", fontface = "bold", size = 10
  ) +
  scale_fill_manual(values = palette_fam) +
  labs(title = "Epibiontes") +
  theme_minimal() +
  theme(legend.position = "none")

# Basebiontes‚úîÔ∏è
g_base <- ggplot(df_base, aes(
  area = abs(n),
  fill = Species,
  label = paste0(Species, "\n", abs(n), " (", round(abs(percentual), 1), "%)")
)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    place = "centre", grow = TRUE, reflow = TRUE,
    color = "white", fontface = "bold", size = 10
  ) +
  scale_fill_manual(values = palette_fam) +
  labs(title = "Basibiontes") +
  theme_minimal() +
  theme(legend.position = "none")

#3Ô∏è‚É£ Juntar os dois:
plots_tree<- g_epi + g_base + plot_layout(ncol = 2)
plots_tree

# ‚úîÔ∏èSALVANDO‚úîÔ∏è
#ggsave("Plots/treemap_spp-contagem.png",
#       plot = plots_tree, width = 14, height = 8, dpi = 600, units = "in")




# 20 mais abundantes ---- n√£o precisa plotar -----


library(dplyr)
library(ggplot2)
library(treemapify)

# 1Ô∏è‚É£ Seleciona as 10 mais abundantes (em ambos os grupos somados)
top10_species <- df %>%
  arrange(desc(total)) %>%
  slice_head(n = 20) %>%
  pull(Species)

# 2Ô∏è‚É£ Marca essas esp√©cies dentro do dataset longo
df_long <- df_long %>%
  mutate(
    destaque = if_else(Species %in% top10_species, TRUE, FALSE)
  )

# 3Ô∏è‚É£ Gr√°fico dos epibiontes com destaque (negrito e it√°lico para top 10)
g_epi <- ggplot(df_long %>% filter(grupo == "Epibiontes", abs(percentual) >= 1.5),
                aes(area = abs(n), fill = Species)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    aes(
      label = ifelse(
        destaque,
        paste0("*", Species, "*\n", abs(n), " (", round(abs(percentual), 1), "%)"),
        ""
      )
    ),
    color = "white", grow = TRUE, reflow = TRUE, size = 10,
    fontface = "bold", lineheight = 0.9
  ) +
  scale_fill_manual(values = palette_fam) +
  labs(title = "Epibiontes ‚Äì 10 esp√©cies mais abundantes") +
  theme_minimal() +
  theme(legend.position = "none")

# 4Ô∏è‚É£ Gr√°fico dos basibiontes (mesma l√≥gica)
g_base <- ggplot(df_long %>% filter(grupo == "Basebiontes", abs(percentual) >= 1.5),
                 aes(area = abs(n), fill = Species)) +
  geom_treemap(color = "white") +
  geom_treemap_text(
    aes(
      label = ifelse(
        destaque,
        paste0("*", Species, "*\n", abs(n), " (", round(abs(percentual), 1), "%)"),
        ""
      )
    ),
    color = "white", grow = TRUE, reflow = TRUE, size = 10,
    fontface = "bold", lineheight = 0.9
  ) +
  scale_fill_manual(values = palette_fam) +
  labs(title = "Basibiontes ‚Äì 10 esp√©cies mais abundantes") +
  theme_minimal() +
  theme(legend.position = "none")

# 5Ô∏è‚É£ Junta os dois gr√°ficos
plots_tree_top10 <- g_epi + g_base + patchwork::plot_layout(ncol = 2)
plots_tree_top10


#
#       üåø C√≥digo completo do gr√°fico espelhado - html -----
library(ggplot2)
library(dplyr)
library(forcats)

# Ordena as esp√©cies pela soma total de registros
df_long <- df_long %>%
  mutate(Species = fct_reorder(Species, total, .desc = TRUE))

# gr√°fico base com texto customizado
g_piramide <- ggplot(df_long, aes(
  x = n, y = Species, fill = grupo,
  text = paste0(
    "<b>Esp√©cie:</b> <i>", Species, "</i><br>",
    "<b>Grupo:</b> ", grupo, "<br>",
    "<b>Registros:</b> ", abs(n), "<br>",
    "<b>Percentual:</b> ", round(abs(percentual), 2), "%"
  )
)) +
  geom_col(width = 0.8, color = "white") +
  scale_fill_manual(values = c("Epibiontes"="#2E8B57","Basebiontes"="#E74C3C")) +
  scale_x_continuous(labels = abs) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.y = element_text(face = "italic"),
    legend.position = "bottom"
  )

# converte e limpa tooltips autom√°ticos
g_piramide_interativo <- ggplotly(g_piramide, tooltip = "text",
                                  width = 1000, height = 3000)

for(i in seq_along(g_piramide_interativo$x$data)){
  g_piramide_interativo$x$data[[i]]$hoverinfo <- "text"
  g_piramide_interativo$x$data[[i]]$text <- g_piramide_interativo$x$data[[i]]$text
}


htmlwidgets::saveWidget(
  g_piramide_interativo,
  "Plots/grafico_piramide_spp_interativo.html",
  selfcontained = TRUE
)


# Mostra o gr√°fico
g_piramide
# ‚úîÔ∏èSALVANDO‚úîÔ∏è
ggsave("Plots/espelhado_spp-contagem.png",
       plot = g_piramide, width = 10, height = 40, dpi = 600, units = "in",
       bg = "white" )  # üëà fundo branco garantido)


library(htmltools)

library(plotly)
library(htmlwidgets)



browseURL("Plots/grafico_piramide_spp_interativo.html")





#1) Contagem epibiontes por fam√≠lia de basibionte (Top N por fam√≠lia)----
library(dplyr)

epi_por_familia_pct <- df1 %>%
  filter(!is.na(Scientific_name_EP), !is.na(BS_Family)) %>%
  count(BS_Family, Scientific_name_EP, name = "n_ocorrencias") %>%
  group_by(BS_Family) %>%
  mutate(
    total_familia = sum(n_ocorrencias),
    percentual_na_familia = 100 * n_ocorrencias / total_familia
  ) %>%
  ungroup() %>%
  rename(
    basibionte_family = BS_Family,
    epibionte_species = Scientific_name_EP
  )

#3) Exportar pra Excel
library(writexl)

#write_xlsx(
  list(
    "Top_epibiontes_por_familia" = epi_por_familia,
    "Epibiontes_por_familia_pct" = epi_por_familia_pct,
   "Generos_autoepibiose" = genus,
   "Familias_autoepibiose" =family
  ),
  "epibiontes_por_familia_basibionte.xlsx"
)

#4) (Opcional) Gr√°fico r√°pido (top epibiontes por fam√≠lia)
library(ggplot2)



# em genero
dfgen <- df1 %>%
  mutate(
    EP_genus = word(Scientific_name_EP, 1),
    BS_genus = word(Scientific_name_BS, 1)
  )

auto_genus <- dfgen %>%
  filter(!is.na(EP_genus), !is.na(BS_genus)) %>%
  filter(EP_genus == BS_genus,
         Scientific_name_EP != Scientific_name_BS)

genus<-dplyr::select(auto_genus,
                     "ID", "EP_genus","BS_genus","Scientific_name_EP",
                     "Scientific_name_BS")


# em familia
auto_family <- df1 %>%
  filter(!is.na(EP_family), !is.na(BS_Family)) %>%
  filter(EP_family == BS_Family)
colnames(auto_family)
auto_family

family<-dplyr::select(auto_family,
                      "ID", "EP_family","BS_Family",
                      "Scientific_name_EP","Scientific_name_BS")

# aquela pergunta desgra√ßada de esp√©cies por  fam√≠lia de basibionte ----




#1Ô∏è‚É£ Contagem absoluta esp√©cie √ó fam√≠lia
library(dplyr)
library(tidyr)

tab_epi_fam <- df1 %>%
  filter(!is.na(Scientific_name_EP), !is.na(BS_Family)) %>%
  count(Scientific_name_EP, BS_Family, name = "n") 

#2Ô∏è‚É£ Transformar em matriz (wide)
mat_epi_fam <-as.data.frame( tab_epi_fam %>%
  pivot_wider(
    names_from = BS_Family,
    values_from = n,
    values_fill = 0
  ))

writexl::write_xlsx(mat_epi_fam, "Data/epibiontes-familiabase.xlsx")
write.csv(mat_epi_fam, "Data/epibiontes-familiabase.csv")

#procurando os valores de na 
# - Est√° tudo tranquilo, sem nas
colSums(is.na(mat_epi_fam))

colunas<- mat_epi_fam[2-20] #seleciona s√≥ as colunas

  
  
  ##################################################################


mat_ca <- mat_epi_fam %>%
  column_to_rownames("Scientific_name_EP") %>%
  as.matrix()

library(vegan)

ca_res <- cca(mat_ca)
summary(ca_res)

plot(ca_res, scaling = 2)~~

#üé® 6Ô∏è‚É£ Gr√°fico bonito com ggplot (recomendado)
library(ggplot2)

scores_sp <- scores(ca_res, display = "species", scaling = 2) %>%
  as.data.frame() %>%
  rownames_to_column("Species")

scores_fam <- scores(ca_res, display = "sites", scaling = 2) %>%
  as.data.frame() %>%
  rownames_to_column("Family")

ggplot() +
  geom_point(data = scores_sp,
             aes(x = CA1, y = CA2),
             color = "steelblue", size = 2) +
  geom_text(data = scores_sp,
            aes(x = CA1, y = CA2, label = Species),
            size = 3, fontface = "italic", hjust = 0.5) +
  geom_point(data = scores_fam,
             aes(x = CA1, y = CA2),
             color = "firebrick", size = 3) +
  geom_text(data = scores_fam,
            aes(x = CA1, y = CA2, label = Family),
            size = 3.5, fontface = "bold") +
  theme_minimal() +
  labs(
    title = "Correspondence Analysis (CA)",
    x = "CA1",
    y = "CA2"
  )
#






#testanto outra coisa
library(dplyr)

edges <- df1 %>%
  filter(!is.na(Scientific_name_EP), !is.na(BS_Family)) %>%
  count(Scientific_name_EP, BS_Family, name = "weight") %>%
  rename(
    epibionte = Scientific_name_EP,
    basifamily = BS_Family
  )

#B) top N esp√©cies por fam√≠lia (recomendado)
topN <- 15
edges_f <- edges %>%
  group_by(basifamily) %>%
  arrange(desc(weight), .by_group = TRUE) %>%
  slice_head(n = topN) %>%
  ungroup()
#3) Criar grafo e plotar (bipartido + labels)
library(igraph)
library(ggraph)
library(tibble)

nodes <- tibble(
  name = unique(c(edges_f$species, edges_f$basifamily)),
  type = ifelse(name %in% edges_f$basifamily, "Family", "Species")
)

g <- graph_from_data_frame(
  d = edges_f %>% rename(from = epibionte, to = family),
  vertices = nodes,
  directed = FALSE
)

ggraph(g, layout = "fr") +
  geom_edge_link(aes(width = weight), alpha = 0.4) +
  geom_node_point(aes(shape = type), size = 3) +
  geom_node_text(
    aes(label = name, fontface = ifelse(type == "Species", "italic", "bold")),
    repel = TRUE, size = 3
  ) +
  theme_void() +
  labs(title = "Rede: Esp√©cies epibiontes √ó Fam√≠lias de basibiontes")